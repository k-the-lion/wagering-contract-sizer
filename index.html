<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Wagering Calculator & Journal</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s, color 0.3s; /* Smooth transition */
Â  Â  Â  Â  }
Â  Â  Â  Â  .table-cell {
Â  Â  Â  Â  Â  Â  padding: 0.75rem;
Â  Â  Â  Â  Â  Â  border: 1px solid #e5e7eb;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-cell {
Â  Â  Â  Â  Â  Â  background-color: #f9fafb;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="number"], input[type="text"], select, textarea {
Â  Â  Â  Â  Â  Â  border-radius: 0.375rem;
Â  Â  Â  Â  Â  Â  border: 1px solid #d1d5db;
Â  Â  Â  Â  Â  Â  padding: 0.5rem;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s, border-color 0.3s, color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Style for new text/journal fields */
Â  Â  Â  Â  .journal-input {
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  padding-left: 0.5rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .lockout-red {
Â  Â  Â  Â  Â  Â  color: #dc2626;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }
Â  Â  Â  Â  .profit-green {
Â  Â  Â  Â  Â  Â  color: #16a34a;
Â  Â  Â  Â  }
Â  Â  Â  Â  .loss-red {
Â  Â  Â  Â  Â  Â  color: #dc2626;
Â  Â  Â  Â  }
Â  Â  Â  Â  .disabled-row {
Â  Â  Â  Â  Â  Â  background-color: #f3f4f6;
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom style for the rating select box */
Â  Â  Â  Â  #ratingScore {
Â  Â  Â  Â  Â  Â  max-width: 100px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  -moz-appearance: none;
Â  Â  Â  Â  Â  Â  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3e%3cpath fill='%236b7280' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e");
Â  Â  Â  Â  Â  Â  background-repeat: no-repeat;
Â  Â  Â  Â  Â  Â  background-position: right 0.5rem center;
Â  Â  Â  Â  Â  Â  background-size: 8px 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- DARK MODE STYLES --- */
Â  Â  Â  Â  body.dark-mode {
Â  Â  Â  Â  Â  Â  background-color: #111827; /* Dark background */
Â  Â  Â  Â  Â  Â  color: #e5e7eb; /* Light text */
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .max-w-7xl {
Â  Â  Â  Â  Â  Â  background-color: #1f2937; /* Darker card background */
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 {
Â  Â  Â  Â  Â  Â  color: #f3f4f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .border-gray-200, body.dark-mode .border {
Â  Â  Â  Â  Â  Â  border-color: #374151 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .bg-gray-50, body.dark-mode .bg-gray-100 {
Â  Â  Â  Â  Â  Â  background-color: #374151 !important;
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .bg-white, body.dark-mode .bg-blue-50 {
Â  Â  Â  Â  Â  Â  background-color: #4b5563 !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Instruction Box Dark Mode Override */
Â  Â  Â  Â  body.dark-mode .instruction-box {
Â  Â  Â  Â  Â  Â  background-color: #1f2937 !important; /* Very dark background for contrast */
Â  Â  Â  Â  Â  Â  border-color: #3b82f6 !important; /* Blue border */
Â  Â  Â  Â  Â  Â  color: #dbeafe !important; /* Very light blue text */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Standard element overrides */
Â  Â  Â  Â  body.dark-mode .table-cell {
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .header-cell {
Â  Â  Â  Â  Â  Â  background-color: #374151;
Â  Â  Â  Â  Â  Â  color: #f3f4f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode input[type="date"], body.dark-mode select, body.dark-mode textarea {
Â  Â  Â  Â  Â  Â  background-color: #1f2937;
Â  Â  Â  Â  Â  Â  color: #f3f4f6;
Â  Â  Â  Â  Â  Â  border-color: #4b5563;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .text-gray-700 {
Â  Â  Â  Â  Â  Â  color: #d1d5db; /* Lighter labels */
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .text-gray-800, body.dark-mode .text-gray-900 {
Â  Â  Â  Â  Â  Â  color: #f3f4f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode .disabled-row {
Â  Â  Â  Â  Â  Â  background-color: #1f2937;
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.dark-mode #ratingScore {
Â  Â  Â  Â  Â  Â  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3e%3cpath fill='%23f3f4f6' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e"); /* Lighten dropdown arrow */
Â  Â  Â  Â  }
Â  Â  </style>
Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8">
Â  Â  <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md p-6">
Â  Â  Â  Â  <header class="mb-6 pb-4 border-b border-gray-200 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Wagering Calculator & Journal</h1>
Â  Â  Â  Â  Â  Â  <button id="darkModeToggle" onclick="toggleDarkMode()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  <svg id="sunIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </header>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="instructionsBox" class="mt-2 p-3 bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-900 instruction-box">
Â  Â  Â  Â  Â  Â  <div id="instructionsHeader" class="font-semibold mb-1 cursor-pointer flex justify-between items-center" onclick="toggleInstructions()">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>How to Use This Tool:</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="toggleArrow" class="transform transition-transform duration-300">â–¼</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="instructionsContent" class="hidden pt-2 border-t border-blue-200 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  <ol class="list-decimal list-inside space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Set Up Your Day:</strong> Enter your account and trade parameters in the boxes above.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Log Trades:</strong> After each trade, enter the P/L and log a <strong>Screenshot Link</strong> and <strong>Notes</strong> in the log below.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Complete Journal:</strong> At the end of the session, fill out the <strong>R.E.A.L.I.S.T. Journal</strong> questions at the bottom.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Save:</strong> Press <strong>Save Current Session</strong> to save your data to your browser or <strong>Clear Log & Start New Day</strong> if you are starting a new day.</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><strong>Export Data:</strong> Use the <strong>Download Trade Log (CSV)</strong> button to save your visible trades. Use the <strong>Download Current R.E.A.L.I.S.T. Journal (CSV)</strong> button at the bottom of the page to save your current on-screen journal answers.</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ol>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mt-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  <div class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="sessionDate" class="block text-sm font-semibold text-gray-700 mb-1">Today's Session Date:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="sessionDate" class="w-full sm:w-1/3 mt-1" value="">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex justify-start items-center flex-wrap gap-3 pt-2 border-t border-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="saveSession()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ’¾ Save Current Session
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="clearLogAndStartNewDay()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ¨ Clear Log & Start New Day
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id="downloadTradeLogButton"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="exportTradeLogToCSV()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“Š Download Trade Log (CSV)
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 mt-6">
Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 p-4 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg mb-3">Account Setup</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="currentBalance" class="block text-sm font-medium text-gray-700">Current Balance ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="currentBalance" value="50000" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="maxLossLimit" class="block text-sm font-medium text-gray-700">Maximum Loss Limit ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="maxLossLimit" value="48000" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="lossLockoutPercent" class="block text-sm font-medium text-gray-700">Loss Lockout %</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="lossLockoutPercent" value="0.10" step="0.001" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 p-4 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg mb-3">Trade Setup</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="tradeRange" class="block text-sm font-medium text-gray-700">Trade Range (Points)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="tradeRange" value="10" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
                    <div>
                        <label for="tickerSelect" class="block text-sm font-medium text-gray-700">Contract</label>
                        <select id="tickerSelect" class="mt-1">
                            <option value="MNQ" selected>MNQ (Micro Nasdaq) - $2/pt</option>
                            <option value="MES">MES (Micro S&P) - $5/pt</option>
                            <option value="MGC">MGC (Micro Gold) - $10/pt</option>
                            <option value="MCL">MCL (Micro Crude) - $1/pt</option>
                            <option value="MYM">MYM (Micro Dow) - $0.50/pt</option>
                        </select>
                    </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 p-4 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg mb-3">Ladder Logic</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="autoLadder" class="block text-sm font-medium text-gray-700">Auto Ladder when Green?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="autoLadder" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="true" selected>On</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="false">Off</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="minProfitToKeep" class="block text-sm font-medium text-gray-700">Absolute minimum profit ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="minProfitToKeep" value="0" class="mt-1">Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="lockInPercent" class="block text-sm font-medium text-gray-700">Lock-in % of current green</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="lockInPercent" value="0.75" step="0.01" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â <div class="bg-gray-50 p-4 rounded-lg border">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg mb-3">Sizing Parameters</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="roundDown" class="block text-sm font-medium text-gray-700">Round down to nearest $</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="roundDown" value="5" step="1" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="feePerContract" class="block text-sm font-medium text-gray-700">Fee per Contract ($)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="feePerContract" value="0.74" step="0.01" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 mt-6">
Â  Â  Â  Â  Â  Â  <div class="bg-emerald-600 text-white p-4 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-emerald-200">Full Stack ($)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="fullStack" class="text-2xl font-bold"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bg-amber-500 text-white p-4 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-amber-100">Daily Loss Lockout ($)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="dailyLossLockout" class="text-2xl font-bold"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bg-blue-600 text-white p-4 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="tpslLabel" class="text-sm font-medium text-blue-200">TP/SL SETTINGS ($)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="nextTradeSize" class="text-2xl font-bold"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="bg-violet-600 text-white p-4 rounded-lg shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-violet-200">NUMBER OF CONTRACTS</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="numContracts" class="text-2xl font-bold">0</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="mt-8 pt-6 border-t">
Â  Â  Â  Â  Â  Â  Â <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Trade Log</h2>
Â  Â  Â  Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <table class="min-w-full divide-y divide-gray-200 border" id="tradeLogTable">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell w-16">Trade #</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell">Recommended TP/SL ($)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell bg-blue-100">Actual Result ($)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell">Realized P&L ($)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell">Lockout</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell bg-gray-100">Screenshot Link</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="table-cell header-cell bg-gray-100">Notes / Rationale</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="trade-rows" class="bg-white divide-y divide-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <hr class="mt-12 mb-6 border-gray-300">

Â  Â  Â  Â  <div class="mt-8 p-6 bg-gray-100 rounded-xl shadow-inner">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  THE R.E.A.L.I.S.T. JOURNAL ğŸ“
Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  <div class="space-y-6">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-red-600 mb-2">R - Rate</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center space-x-4 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="ratingScore" class="block text-sm font-medium text-gray-700">Rating (1 to 5):</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="ratingScore" class="mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="5">5 - Excellent</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="4">4 - Good</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="3" selected>3 - Average</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="2">2 - Poor</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="1">1 - Terrible</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="ratingReason" class="block text-sm font-medium text-gray-700 mb-1">Why did you give it that score?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="ratingReason" rows="2" class="journal-input" placeholder="My score reflects my discipline and market read..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-blue-600 mb-2">E - Earnings</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="earningsNote" class="block text-sm font-medium text-gray-700 mb-1">Were you profitable today? If not, what was the loss and why?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="earningsNote" rows="2" class="journal-input" placeholder="I was profitable by $175 and locked out according to the wagering strategy..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-emerald-600 mb-2">A - Alignment</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="alignmentNote" class="block text-sm font-medium text-gray-700 mb-1">Did you follow your trading strategy today? If not, what caused you to go off-strategy?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="alignmentNote" rows="2" class="journal-input" placeholder="Yes, I stuck to my plan, or No, fear/greed caused me to..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-amber-600 mb-2">L - Learning</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="learningNote" class="block text-sm font-medium text-gray-700 mb-1">What did you learn from the market, your behavior, or your decisions today?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="learningNote" rows="3" class="journal-input" placeholder="I do well when I walk away after each trade..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-purple-600 mb-2">I - Improvements</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="improvementNote" class="block text-sm font-medium text-gray-700 mb-1">What could you have done better? How will you correct or prevent that?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="improvementNote" rows="3" class="journal-input" placeholder="I should have waited for confirmation. Next time, I will..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-cyan-600 mb-2">S - Sorry</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="sorryNote" class="block text-sm font-medium text-gray-700 mb-1">Do you regret any trades? What would you change if you could redo it?</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="sorryNote" rows="2" class="journal-input" placeholder="I regret Trade #4. It was a FOMO trade. Next time I will..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 bg-white rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-semibold text-lg text-pink-600 mb-2">T - Trading Plan (Tomorrow)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="tomorrowPlan" class="block text-sm font-medium text-gray-700 mb-1">What's your exact plan for tomorrow's trading? Be specific.</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="tomorrowPlan" rows="3" class="journal-input" placeholder="I will only trade between 9:30-10:00 AM, while taking a break after every trade. I will also..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-6 pt-6 border-t border-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  <buttonÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id="downloadCurrentJournalButton"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="exportCurrentJournalToCSV()"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm w-full sm:w-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ“ Download Current R.E.A.L.I.S.T. Journal (CSV)
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- DARK MODE LOGIC START ---
Â  Â  Â  Â  function toggleDarkMode() {
Â  Â  Â  Â  Â  Â  const body = document.body;
Â  Â  Â  Â  Â  Â  const isDarkMode = body.classList.toggle('dark-mode');
Â  Â  Â  Â  Â  Â  localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
Â  Â  Â  Â  Â  Â  updateToggleIcon(isDarkMode);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateToggleIcon(isDarkMode) {
Â  Â  Â  Â  Â  Â  const sunIcon = document.getElementById('sunIcon');
Â  Â  Â  Â  Â  Â  const moonIcon = document.getElementById('moonIcon');
Â  Â  Â  Â  Â  Â  if (sunIcon && moonIcon) {
Â  Â  Â  Â  Â  Â  Â  Â  sunIcon.classList.toggle('hidden', isDarkMode);
Â  Â  Â  Â  Â  Â  Â  Â  moonIcon.classList.toggle('hidden', !isDarkMode);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadDarkModePreference() {
Â  Â  Â  Â  Â  Â  if (localStorage.getItem('darkMode') === 'enabled') {
Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('dark-mode');
Â  Â  Â  Â  Â  Â  Â  Â  updateToggleIcon(true);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  updateToggleIcon(false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- DARK MODE LOGIC END ---

        // ADDED TICKER CONSTANTS HERE
        const TICKER_VALUES = {
            "MNQ": 2.00,
            "MES": 5.00,
            "MGC": 10.00,
            "MCL": 1.00,
            "MYM": 0.50
        };

Â  Â  Â  Â  const NUM_TRADES = 50;
Â  Â  Â  Â  const INPUT_ELEMENT_IDS = [
Â  Â  Â  Â  Â  Â  // Settings
Â  Â  Â  Â  Â  Â  'currentBalance', 'maxLossLimit', 'lossLockoutPercent', 'tradeRange', 'autoLadder',Â 
Â  Â  Â  Â  Â  Â  'minProfitToKeep', 'lockInPercent', 'roundDown', 'feePerContract', 'tickerSelect', // Added tickerSelect here
Â  Â  Â  Â  Â  Â  // R.E.A.L.I.S.T. Journal
Â  Â  Â  Â  Â  Â  'ratingScore', 'ratingReason', 'earningsNote', 'alignmentNote', 'learningNote',Â 
Â  Â  Â  Â  Â  Â  'improvementNote', 'sorryNote', 'tomorrowPlan',
Â  Â  Â  Â  Â  Â  // Date
Â  Â  Â  Â  Â  Â  'sessionDate'
Â  Â  Â  Â  ];

Â  Â  Â  Â  // --- ACCORDION LOGIC ---
Â  Â  Â  Â  function toggleInstructions() {
Â  Â  Â  Â  Â  Â  const content = document.getElementById('instructionsContent');
Â  Â  Â  Â  Â  Â  const arrow = document.getElementById('toggleArrow');
Â  Â  Â  Â  Â  Â  if (content.classList.contains('hidden')) {
Â  Â  Â  Â  Â  Â  Â  Â  content.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  arrow.classList.add('rotate-180'); // Rotate arrow up
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  content.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  arrow.classList.remove('rotate-180'); // Rotate arrow down
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- SESSION MANAGEMENT LOGIC ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Helper function to safely get the session data
Â  Â  Â  Â  function getSessionData() {
Â  Â  Â  Â  Â  Â  const savedData = localStorage.getItem('tradingSessionData');
Â  Â  Â  Â  Â  Â  if (!savedData) {
Â  Â  Â  Â  Â  Â  Â  Â  return {}; // Return empty object if nothing is saved
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  return JSON.parse(savedData);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to parse session data:", e);
Â  Â  Â  Â  Â  Â  Â  Â  return {}; // Return empty object on parse error
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // (FIXED) This button saves the VISIBLE state AND preserves history
Â  Â  Â  Â  function saveSession() {
Â  Â  Â  Â  Â  Â  // 1. Load existing data, including history keys
Â  Â  Â  Â  Â  Â  const sessionData = getSessionData();

Â  Â  Â  Â  Â  Â  // 2. Update all settings and journal fields
Â  Â  Â  Â  Â  Â  INPUT_ELEMENT_IDS.forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  const element = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (element) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionData[id] = element.value;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 3. Save only the *visible* Trade Log data
Â  Â  Â  Â  Â  Â  const tradeLogData = [];
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= NUM_TRADES; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const resultInput = document.getElementById(`result-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (resultInput && resultInput.value.trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tradeLogData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result: resultInput.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screenshot: document.getElementById(`screenshot-${i}`).value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  notes: document.getElementById(`notes-${i}`).value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  sessionData['tradeLog'] = tradeLogData; // This is the VISIBLE log
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 4. The 'realistHistory' key is already on sessionData (from step 1) and is NOT touched.
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  localStorage.setItem('tradingSessionData', JSON.stringify(sessionData));
Â  Â  Â  Â  Â  Â  alert("Session Saved! Your visible data and historical history are preserved.");
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadSession() {
Â  Â  Â  Â  Â  Â  const sessionData = getSessionData();

Â  Â  Â  Â  Â  Â  // 1. Load Settings and Journal
Â  Â  Â  Â  Â  Â  INPUT_ELEMENT_IDS.forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  const element = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (element && sessionData[id] !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element.value = sessionData[id];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // If sessionDate isn't in saved data or is blank, set today's date
Â  Â  Â  Â  Â  Â  if (!sessionData['sessionDate'] || sessionData['sessionDate'] === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('sessionDate').value = new Date().toISOString().substring(0, 10);
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  // 2. Load Trade Log Data (only the current/latest visible log)
Â  Â  Â  Â  Â  Â  if (sessionData.tradeLog) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionData.tradeLog.forEach((trade, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const i = index + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById(`result-${i}`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`result-${i}`).value = trade.result || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`screenshot-${i}`).value = trade.screenshot || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`notes-${i}`).value = trade.notes || '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function clearLogAndStartNewDay() {
Â  Â  Â  Â  Â  Â  // 1. Check if the user wants to keep the data
Â  Â  Â  Â  Â  Â  const confirmClear = confirm("Are you sure you want to clear the on-screen Trade Log and R.E.A.L.I.S.T. Journal for a new day?\n\nNOTE: The current R.E.A.L.I.S.T. data will be saved to history, but the screen will be wiped.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!confirmClear) return;

Â  Â  Â  Â  Â  Â  // --- DATA ACCUMULATION FOR HISTORY (ONLY FOR REALIST) ---

Â  Â  Â  Â  Â  Â  // A. Get current day's data
Â  Â  Â  Â  Â  Â  const currentSessionData = {};
Â  Â  Â  Â  Â  Â  INPUT_ELEMENT_IDS.forEach(id => {
Â  Â  Â  Â  Â  Â  Â  Â  const element = document.getElementById(id);
Â  Â  Â  Â  Â  Â  Â  Â  if (element) { currentSessionData[id] = element.value; }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // B. Load existing history
Â  Â  Â  Â  Â  Â  const existingSession = getSessionData();
Â  Â  Â  Â  Â  Â  let historicalRealistLog = existingSession['realistHistory'] || [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // C. Append the current R.E.A.L.I.S.T. journal entry to the realist history
Â  Â  Â  Â  Â  Â  const currentRealistEntry = {
Â  Â  Â  Â  Â  Â  Â  Â  date: currentSessionData['sessionDate'] || new Date().toISOString().substring(0, 10),
Â  Â  Â  Â  Â  Â  Â  Â  ratingScore: currentSessionData['ratingScore'],
Â  Â  Â  Â  Â  Â  Â  Â  ratingReason: currentSessionData['ratingReason'],
Â  Â  Â  Â  Â  Â  Â  Â  earningsNote: currentSessionData['earningsNote'],
Â  Â  Â  Â  Â  Â  Â  Â  alignmentNote: currentSessionData['alignmentNote'],
Â  Â  Â  Â  Â  Â  Â  Â  learningNote: currentSessionData['learningNote'],
Â  Â  Â  Â  Â  Â  Â  Â  improvementNote: currentSessionData['improvementNote'],
Â  Â  Â  Â  Â  Â  Â  Â  sorryNote: currentSessionData['sorryNote'],
Â  Â  Â  Â  Â  Â  Â  Â  tomorrowPlan: currentSessionData['tomorrowPlan']
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // FIX: Check ALL fields, not just the first three
Â  Â  Â  Â  Â  Â  if (currentRealistEntry.ratingScore !== '3' ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.ratingReason || '').trim() !== '' ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.earningsNote || '').trim() !== '' ||
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.alignmentNote || '').trim() !== '' ||
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.learningNote || '').trim() !== '' ||
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.improvementNote || '').trim() !== '' ||
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.sorryNote || '').trim() !== '' ||
Â  Â  Â  Â  Â  Â  Â  Â  (currentRealistEntry.tomorrowPlan || '').trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â historicalRealistLog.push(currentRealistEntry);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // D. Save the ENTIRE accumulated history and reset the current log state
Â  Â  Â  Â  Â  Â  let updatedSessionData = currentSessionData;
Â  Â  Â  Â  Â  Â  updatedSessionData['realistHistory'] = historicalRealistLog;
Â  Â  Â  Â  Â  Â  // Clear the visible tradeLog key
Â  Â  Â  Â  Â  Â  updatedSessionData['tradeLog'] = [];Â 
Â  Â  Â  Â  Â  Â  // We NO LONGER save tradeLogHistory, to avoid conflicts.
Â  Â  Â  Â  Â  Â  delete updatedSessionData['tradeLogHistory'];Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  localStorage.setItem('tradingSessionData', JSON.stringify(updatedSessionData));


Â  Â  Â  Â  Â  Â  // 3. Clear all inputs on screen
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= NUM_TRADES; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById(`result-${i}`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`result-${i}`).value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`screenshot-${i}`).value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`notes-${i}`).value = '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Reset Journal inputs to default/empty state
Â  Â  Â  Â  Â  Â  document.getElementById('ratingScore').value = '3';
Â  Â  Â  Â  Â  Â  document.getElementById('ratingReason').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('earningsNote').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('alignmentNote').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('learningNote').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('improvementNote').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('sorryNote').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('tomorrowPlan').value = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set session date to today for the new day
Â  Â  Â  Â  Â  Â  document.getElementById('sessionDate').value = new Date().toISOString().substring(0, 10);


Â  Â  Â  Â  Â  Â  // 4. Re-calculate to show the clean log and reset Trade #1's recommended size
Â  Â  Â  Â  Â  Â  calculate();

Â  Â  Â  Â  Â  Â  alert("New Trading Day Started. The R.E.A.L.I.S.T. history is saved!");
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNCTION REMOVED ---
Â  Â  Â  Â  // function clearAllSavedData() { ... }

Â  Â  Â  Â  // --- END SESSION MANAGEMENT LOGIC ---


Â  Â  Â  Â  // Utility function for downloading CSV
Â  Â  Â  Â  function downloadCSV(csvString, filename) {
Â  Â  Â  Â  Â  Â  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (link.download !== undefined) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute('href', url);
Â  Â  Â  Â  Â  Â  Â  Â  link.setAttribute('download', filename);
Â  Â  Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  Â  Â  Â  Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert("Your browser does not support automatic downloads. Please copy the data manually.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- (FIXED) HELPER FUNCTION: Now accepts raw strings/numbers ---
Â  Â  Â  Â  function getCleanedValue(value) {
Â  Â  Â  Â  Â  Â  // Convert value to string in case it's a number or null/undefined
Â  Â  Â  Â  Â  Â  let text = String(value || '').trim();
Â  Â  Â  Â  Â  Â  text = text.replace(/"/g, '""'); // Escape double quotes
Â  Â  Â  Â  Â  Â  if (text.includes(',') || text.includes('\n') || text.includes('"')) {
Â  Â  Â  Â  Â  Â  Â  Â  text = `"${text}"`; // Enclose if it contains delimiter, newline, or quotes
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return text;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- (FIXED) EXPORT TRADE LOG FUNCTION (Reverted to VISIBLE, FILTERED EXPORT) ---
Â  Â  Â  Â  function exportTradeLogToCSV() {
Â  Â  Â  Â  Â  Â  let csv = [];
Â  Â  Â  Â  Â  Â  const sessionDate = document.getElementById('sessionDate').value || 'N/A';

Â  Â  Â  Â  Â  Â  // 1. Define Header Row (Hardcoded for stability)
Â  Â  Â  Â  Â  Â  const headerData = [
Â  Â  Â  Â  Â  Â  Â  Â  'Date',
Â  Â  Â  Â  Â  Â  Â  Â  'Trade #',
Â  Â  Â  Â  Â  Â  Â  Â  'Recommended TP/SL ($)',
Â  Â  Â  Â  Â  Â  Â  Â  'Actual Result ($)',
Â  Â  Â  Â  Â  Â  Â  Â  'Realized P&L ($)',
Â  Â  Â  Â  Â  Â  Â  Â  'Lockout',
Â  Â  Â  Â  Â  Â  Â  Â  'Screenshot Link',
Â  Â  Â  Â  Â  Â  Â  Â  'Notes / Rationale'
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  csv.push("--- CURRENT SESSION TRADE LOG ---");
Â  Â  Â  Â  Â  Â  csv.push(headerData.map(getCleanedValue).join(',')); // Use helper for header

Â  Â  Â  Â  Â  Â  // 2. Get Data Rows (Only those with Actual Result)
Â  Â  Â  Â  Â  Â  let tradesFound = 0;
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= NUM_TRADES; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const resultInput = document.getElementById(`result-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Check if the 'Actual Result ($)' input is filled. If not, skip the row.
Â  Â  Â  Â  Â  Â  Â  Â  if (resultInput && resultInput.value.trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tradesFound++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Get row data directly by ID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rowData = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionDate,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  i, // Trade #
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`recommended-tpsl-${i}`).innerText,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultInput.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`running-pl-${i}`).innerText,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`lockout-${i}`).innerText,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`screenshot-${i}`).value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`notes-${i}`).value
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  csv.push(rowData.map(getCleanedValue).join(',')); // Use helper for data
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (tradesFound === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("No trade entries are visible in the log to export.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const csvString = csv.join('\n');
Â  Â  Â  Â  Â  Â  const filename = `Current_Trade_Log_${sessionDate.replace(/-/g, '')}.csv`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  downloadCSV(csvString, filename);
Â  Â  Â  Â  Â  Â  alert(`Downloaded ${tradesFound} visible trade entries for ${sessionDate}.`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- (NEW) EXPORT CURRENT ON-SCREEN REALIST JOURNAL ---
Â  Â  Â  Â  function exportCurrentJournalToCSV() {
Â  Â  Â  Â  Â  Â  const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().substring(0, 10);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let csv = [];
Â  Â  Â  Â  Â  Â  // 1. Define Header
Â  Â  Â  Â  Â  Â  csv.push('--- CURRENT R.E.A.L.I.S.T. JOURNAL ENTRY ---');
Â  Â  Â  Â  Â  Â  csv.push('Date,Rating,Rating Reason,Earnings Note,Alignment Note,Learning Note,Improvement Note,Sorry Note,Tomorrow Plan');

Â  Â  Â  Â  Â  Â  // 2. Get current values from DOM
Â  Â  Â  Â  Â  Â  const ratingSelect = document.getElementById('ratingScore');
Â  Â  Â  Â  Â  Â  const ratingValue = ratingSelect.value;
Â  Â  Â  Â  Â  Â  const ratingOption = ratingSelect.querySelector(`option[value="${ratingValue}"]`);
Â  Â  Â  Â  Â  Â  const ratingDescription = ratingOption ? ratingOption.innerText : 'N/A';

Â  Â  Â  Â  Â  Â  let rowData = [
Â  Â  Â  Â  Â  Â  Â  Â  sessionDate,
Â  Â  Â  Â  Â  Â  Â  Â  ratingValue + ' - ' + ratingDescription,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('ratingReason').value,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('earningsNote').value,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('alignmentNote').value,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('learningNote').value,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('improvementNote').value,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('sorryNote').value,
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tomorrowPlan').value
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  csv.push(rowData.map(item => getCleanedValue(item)).join(',')); // Use helper for data

Â  Â  Â  Â  Â  Â  const csvString = csv.join('\n');
Â  Â  Â  Â  Â  Â  const filename = `Current_REALIST_Journal_${sessionDate.replace(/-/g, '')}.csv`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  downloadCSV(csvString, filename);
Â  Â  Â  Â  Â  Â  alert(`Downloaded current R.E.A.L.I.S.T. Journal entry for ${sessionDate}.`);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- CORE CALCULATION LOGIC ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getFloatValue(id) {
Â  Â  Â  Â  Â  Â  return parseFloat(document.getElementById(id).value) || 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  function getBoolValue(id) {
Â  Â  Â  Â  Â  Â  return document.getElementById(id).value === 'true';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function calculateContracts() {
Â  Â  Â  Â  Â  Â  const dollarRiskText = document.getElementById('nextTradeSize').textContent;
Â  Â  Â  Â  Â  Â  if (dollarRiskText === "LOCKED OUT") {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('numContracts').textContent = "N/A";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const dollarRisk = parseFloat(dollarRiskText) || 0;
Â  Â  Â  Â  Â  Â  const tradeRange = getFloatValue('tradeRange');
            
            // REPLACED HARDCODED VALUE
Â  Â  Â  Â  Â  Â  const pointValue = TICKER_VALUES[document.getElementById('tickerSelect').value] || 2;

Â  Â  Â  Â  Â  Â  const riskPerContract = tradeRange * pointValue;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let numContracts = 0;
Â  Â  Â  Â  Â  Â  if (riskPerContract > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  numContracts = Math.floor(dollarRisk / riskPerContract);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('numContracts').textContent = numContracts;
Â  Â  Â  Â  }

Â  Â  Â  Â  function calculate() {
Â  Â  Â  Â  Â  Â  // Get all parameters
Â  Â  Â  Â  Â  Â  const currentBalance = getFloatValue('currentBalance');
Â  Â  Â  Â  Â  Â  const maxLossLimit = getFloatValue('maxLossLimit');
Â  Â  Â  Â  Â  Â  const lossLockoutPercent = getFloatValue('lossLockoutPercent');
Â  Â  Â  Â  Â  Â  const roundDown = getFloatValue('roundDown');
Â  Â  Â  Â  Â  Â  const autoLadder = getBoolValue('autoLadder');
Â  Â  Â  Â  Â  Â  const minProfitToKeep = getFloatValue('minProfitToKeep');
Â  Â  Â  Â  Â  Â  const lockInPercent = getFloatValue('lockInPercent');
Â  Â  Â  Â  Â  Â  const feePerContract = getFloatValue('feePerContract');

Â  Â  Â  Â  Â  Â  // Initial calculations
Â  Â  Â  Â  Â  Â  const fullStack = currentBalance - maxLossLimit;
Â  Â  Â  Â  Â  Â  const dailyLossLockout = fullStack * lossLockoutPercent;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('fullStack').textContent = fullStack.toFixed(2);
Â  Â  Â  Â  Â  Â  document.getElementById('dailyLossLockout').textContent = `-${dailyLossLockout.toFixed(2)}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // BUG FIX: Reset all rows before recalculating to handle corrections
Â  Â  Â  Â  Â  Â  for (let j = 1; j <= NUM_TRADES; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`trade-row-${j}`).classList.remove('disabled-row');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`result-${j}`).disabled = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let runningPL = 0;
Â  Â  Â  Â  Â  Â  let isLockedOut = false;
Â  Â  Â  Â  Â  Â  let nextTradeSizeFound = false;

Â  Â  Â  Â  Â  Â  for (let i = 1; i <= NUM_TRADES; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const resultInput = document.getElementById(`result-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â  const recommendedTpslSpan = document.getElementById(`recommended-tpsl-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â  const runningPlSpan = document.getElementById(`running-pl-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â  const lockoutSpan = document.getElementById(`lockout-${i}`);

Â  Â  Â  Â  Â  Â  Â  Â  const prevRunningPL = (i === 1) ? 0 : parseFloat(document.getElementById(`running-pl-${i - 1}`).textContent) || 0;

Â  Â  Â  Â  Â  Â  Â  Â  let recommendedTpsl = 0;
Â  Â  Â  Â  Â  Â  Â  Â  if (!isLockedOut) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tradeRange = getFloatValue('tradeRange');

                    // REPLACED HARDCODED VALUE
Â  Â  Â  Â  Â  Â          const pointValue = TICKER_VALUES[document.getElementById('tickerSelect').value] || 2;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const riskPerContract = tradeRange * pointValue;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rawRisk = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- CORRECTED WAGERING LOGIC ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Trade #1: Always risk 50% of the daily lockout limit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawRisk = dailyLossLockout * 0.5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Only apply the profit-reinvestment (Ladder) logic if we are green ANDÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // the profit is equal to or greater than the absolute minimum profit to keep.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (autoLadder && prevRunningPL > 0 && prevRunningPL >= minProfitToKeep) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const profitToRisk = prevRunningPL - Math.max(minProfitToKeep, prevRunningPL * lockInPercent);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawRisk = profitToRisk;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Default logic: 50% of the remaining buffer to hit the daily lockout limit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawRisk = (dailyLossLockout + prevRunningPL) * 0.5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ---------------------------------

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let numContractsForFee = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (riskPerContract > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  numContractsForFee = Math.floor(rawRisk / riskPerContract);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalFee = numContractsForFee * feePerContract * 2; // * 2 for entry/exit

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalRisk = rawRisk - totalFee;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recommendedTpsl = Math.floor(Math.max(0, finalRisk) / roundDown) * roundDown;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  recommendedTpslSpan.textContent = recommendedTpsl.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!isLockedOut && !nextTradeSizeFound) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (resultInput.value.trim() === '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('nextTradeSize').textContent = recommendedTpsl.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â nextTradeSizeFound = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const actualResult = parseFloat(resultInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  runningPL = prevRunningPL + actualResult;

Â  Â  Â  Â  Â  Â  Â  Â  runningPlSpan.textContent = runningPL.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  runningPlSpan.classList.toggle('profit-green', runningPL > 0);
Â  Â  Â  Â  Â  Â  Â  Â  runningPlSpan.classList.toggle('loss-red', runningPL < 0);

Â  Â  Â  Â  Â  Â  Â  Â  let lockoutMsg = "";
Â  Â  Â  Â  Â  Â  Â  Â  if (dailyLossLockout > 0 && runningPL <= -dailyLossLockout) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lockoutMsg = "LOCKOUT (Daily Loss)";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLockedOut = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (autoLadder && prevRunningPL > 0 && actualResult < 0 && prevRunningPL >= minProfitToKeep) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ladder Loss Lockout only applies if we were in the aggressive profit-reinvestment mode
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lockoutMsg = "LOCKOUT (Ladder Loss)";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isLockedOut = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  lockoutSpan.textContent = lockoutMsg;
Â  Â  Â  Â  Â  Â  Â  Â  lockoutSpan.classList.add('lockout-red');

Â  Â  Â  Â  Â  Â  Â  Â  if (isLockedOut) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let j = i + 1; j <= NUM_TRADES; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`trade-row-${j}`).classList.add('disabled-row');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`result-${j}`).disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isLockedOut) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nextTradeSize').textContent = "LOCKED OUT";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nextTradeSize').parentElement.classList.add('bg-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nextTradeSize').parentElement.classList.remove('bg-blue-600');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nextTradeSize').parentElement.classList.remove('bg-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nextTradeSize').parentElement.classList.add('bg-blue-600');
Â  Â  Â  Â  Â  Â  Â  Â  if (!nextTradeSizeFound) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Logic for the next trade size if all 50 log rows are filled
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastRunningPL = parseFloat(document.getElementById(`running-pl-${NUM_TRADES}`).textContent) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tradeRange = getFloatValue('tradeRange');

                    // REPLACED HARDCODED VALUE
Â  Â  Â  Â  Â  Â          const pointValue = TICKER_VALUES[document.getElementById('tickerSelect').value] || 2;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const riskPerContract = tradeRange * pointValue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let rawRisk = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (autoLadder && lastRunningPL > 0 && lastRunningPL >= minProfitToKeep) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const profitToRisk = lastRunningPL - Math.max(minProfitToKeep, lastRunningPL * lockInPercent);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawRisk = profitToRisk;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawRisk = (dailyLossLockout + lastRunningPL) * 0.5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let numContractsForFee = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (riskPerContract > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  numContractsForFee = Math.floor(rawRisk / riskPerContract);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalFee = numContractsForFee * feePerContract * 2; // * 2 for entry/exit

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalRisk = rawRisk - totalFee;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalTradeSize = Math.floor(Math.max(0, finalRisk) / roundDown) * roundDown;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nextTradeSize').textContent = finalTradeSize.toFixed(2);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  calculateContracts();
Â  Â  Â  Â  }

Â  Â  Â  Â  function createTradeRows() {
Â  Â  Â  Â  Â  Â  const tbody = document.getElementById('trade-rows');
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= NUM_TRADES; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const row = document.createElement('tr');
Â  Â  Â  Â  Â  Â  Â  Â  row.id = `trade-row-${i}`;
Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell font-medium">${i}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell font-mono"><span id="recommended-tpsl-${i}">0.00</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell bg-blue-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="result-${i}" class="result-input font-mono" placeholder="0.00" step="0.01">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell font-mono font-semibold"><span id="running-pl-${i}">0.00</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell"><span id="lockout-${i}"></span></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="screenshot-${i}" class="journal-input" placeholder="Paste link here..." maxlength="200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="table-cell">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="notes-${i}" class="journal-input" placeholder="Market structure, setup type, etc..." maxlength="200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  tbody.appendChild(row);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  loadDarkModePreference(); // Load dark mode preference
Â  Â  Â  Â  Â  Â  createTradeRows();
Â  Â  Â  Â  Â  Â  loadSession(); // Load saved session data
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Run calculation immediately after loading default/saved settings
Â  Â  Â  Â  Â  Â  calculate();Â 

Â  Â  Â  Â  Â  Â  // Attach listeners AFTER initial load and calculation
Â  Â  Â  Â  Â  Â  const inputs = document.querySelectorAll('input, select, textarea');
Â  Â  Â  Â  Â  Â  inputs.forEach(input => input.addEventListener('input', calculate));
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
